<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trades Sign-in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f8fafc;
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #f8fafc;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }

        /* Custom Modal CSS */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body class="p-6 md:p-10 flex flex-col items-center">

    <!-- Modal for messages -->
    <div id="message-modal" class="modal">
        <div class="bg-white p-6 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3">
            <div id="modal-content" class="text-center"></div>
            <button onclick="document.getElementById('message-modal').style.display='none'"
                class="mt-4 w-full bg-indigo-600 text-white py-2 px-4 rounded-full font-semibold hover:bg-indigo-700 transition duration-300">Close</button>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loading" class="absolute inset-0 flex items-center justify-center bg-gray-100 bg-opacity-75 z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <!-- Header & Logo -->
    <header class="w-full max-w-4xl text-center mb-6">
        <div class="flex justify-center mb-4">
            <!-- Placeholder for your logo -->
            <img src="https://placehold.co/150x60/d4d4d8/27272a?text=LOGO" alt="Company Logo"
                class="rounded-lg shadow-md" />
        </div>
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">Building Access Log</h1>
        <p class="mt-2 text-gray-500">Trades Sign-in and Sign-out for safety compliance.</p>
        <p id="user-info" class="text-xs text-gray-400 mt-2 break-all">Connecting to server...</p>
    </header>

    <main class="w-full max-w-4xl bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-200">

        <!-- Sign-in Form -->
        <form id="sign-in-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="business-name" class="block text-sm font-medium text-gray-700">Business Name</label>
                    <input type="text" id="business-name" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="person-name" class="block text-sm font-medium text-gray-700">Person's Name</label>
                    <input type="text" id="person-name" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="contact-number" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                    <input type="tel" id="contact-number" required pattern="[0-9]{10}" title="Please enter a 10-digit mobile number"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="job-info" class="block text-sm font-medium text-gray-700">Job Information</label>
                    <input type="text" id="job-info" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
            </div>

            <button type="submit"
                class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-full shadow-md hover:bg-indigo-700 transition duration-300 ease-in-out transform hover:scale-105">
                Sign In
            </button>
        </form>

        <hr class="my-8 border-gray-200">

        <!-- Log Display -->
        <div class="scroll-container bg-gray-50 p-4 rounded-xl border border-gray-200">
            <div id="log-display" class="space-y-4">
                <p class="text-center text-gray-500">Loading log data...</p>
            </div>
        </div>

    </main>

    <script>
        // REPLACE THIS WITH YOUR DEPLOYED WORKER URL
        const WORKER_URL = "http://127.0.0.1:8787";

        // UI elements
        const signInForm = document.getElementById('sign-in-form');
        const logDisplay = document.getElementById('log-display');
        const userInfo = document.getElementById('user-info');
        const loadingSpinner = document.getElementById('loading');
        const messageModal = document.getElementById('message-modal');
        const modalContent = document.getElementById('modal-content');

        const showMessage = (message) => {
            modalContent.innerHTML = `<p class="text-lg font-semibold">${message}</p>`;
            messageModal.style.display = 'flex';
        };

        const showLoading = () => loadingSpinner.classList.remove('hidden');
        const hideLoading = () => loadingSpinner.classList.add('hidden');

        // Fetch logs from the worker every 5 seconds (polling)
        const fetchLogs = async () => {
            try {
                showLoading();
                const response = await fetch(`${WORKER_URL}/api/logs`);
                const logs = await response.json();
                renderLog(logs.results);
            } catch (error) {
                console.error("Error fetching logs:", error);
                showMessage("Failed to load logs from server. Please check the worker URL.");
            } finally {
                hideLoading();
            }
        };

        // Render functions
        const renderLog = (logs) => {
            const now = new Date();
            const todayLogs = logs.filter(log => {
                if (!log.signInTime) return false;
                const signInDate = new Date(log.signInTime);
                return signInDate.toDateString() === now.toDateString();
            });

            logDisplay.innerHTML = '';
            if (todayLogs.length === 0) {
                logDisplay.innerHTML = `<p class="text-center text-gray-500 p-4">No entries to display for today.</p>`;
                return;
            }

            // Sort logs by sign-in time (newest first)
            todayLogs.sort((a, b) => new Date(b.signInTime) - new Date(a.signInTime));

            todayLogs.forEach(log => {
                const statusColor = log.status === 'in' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const signOutText = log.signOutTime ? `<span class="text-xs text-gray-500">Out: ${new Date(log.signOutTime).toLocaleTimeString()}</span>` : '';
                
                // Add a sign-out button if the person is currently signed in
                const signOutButton = log.status === 'in' ? 
                    `<button data-id="${log.id}" class="sign-out-btn ml-4 px-4 py-1 text-sm bg-red-500 text-white rounded-full hover:bg-red-600 transition duration-300">Sign Out</button>` : '';

                const logCard = `
                    <div class="bg-white p-4 rounded-xl shadow border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center">
                                <h3 class="font-bold text-lg">${log.personName}</h3>
                                ${signOutButton}
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">${log.status === 'in' ? 'Signed In' : 'Signed Out'}</span>
                        </div>
                        <p class="text-sm text-gray-600"><strong>Business:</strong> ${log.businessName}</p>
                        <p class="text-sm text-gray-600"><strong>Job:</strong> ${log.jobInfo}</p>
                        <p class="text-sm text-gray-600"><strong>Contact:</strong> ${log.mobileNumber}</p>
                        <div class="mt-2 text-sm text-gray-400">
                            <span>In: ${new Date(log.signInTime).toLocaleTimeString()}</span>
                            ${signOutText}
                        </div>
                    </div>
                `;
                logDisplay.innerHTML += logCard;
            });

            // Attach event listeners to the new sign-out buttons
            document.querySelectorAll('.sign-out-btn').forEach(button => {
                button.addEventListener('click', handleSignOut);
            });
        };

        const handleSignOut = async (e) => {
            const docId = e.target.dataset.id;
            if (!docId) {
                showMessage("Could not find log entry to sign out.");
                return;
            }
            showLoading();
            try {
                const response = await fetch(`${WORKER_URL}/api/signout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: docId })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage("You have been successfully signed out.");
                } else {
                    throw new Error(result.error || 'Sign out failed.');
                }
            } catch (error) {
                console.error("Error signing out:", error);
                showMessage("An error occurred. Could not record your sign-out.");
            } finally {
                hideLoading();
                // Force a log refresh
                fetchLogs();
            }
        };

        // Event Listeners
        signInForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const businessName = document.getElementById('business-name').value.trim();
            const personName = document.getElementById('person-name').value.trim();
            const mobileNumber = document.getElementById('contact-number').value.trim();
            const jobInfo = document.getElementById('job-info').value.trim();

            const mobileNumberRegex = /^[0-9]{10}$/;
            if (!mobileNumberRegex.test(mobileNumber)) {
                showMessage("Please enter a valid 10-digit mobile number.");
                return;
            }

            showLoading();

            try {
                const response = await fetch(`${WORKER_URL}/api/signin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ businessName, personName, mobileNumber, jobInfo })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(`You have been successfully signed in.`);
                    signInForm.reset();
                } else {
                    throw new Error(result.error || 'Sign in failed.');
                }
            } catch (error) {
                console.error("Error signing in:", error);
                showMessage("An error occurred. Could not record your entry.");
            } finally {
                hideLoading();
                // Force a log refresh
                fetchLogs();
            }
        });

        // Initial setup and polling
        fetchLogs();
        setInterval(fetchLogs, 5000); // Poll for new logs every 5 seconds
    </script>
</body>

</html>
